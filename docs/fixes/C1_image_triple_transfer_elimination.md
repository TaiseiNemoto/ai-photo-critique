# C1: ç”»åƒãƒ‡ãƒ¼ã‚¿ã®3é‡è»¢é€å•é¡Œä¿®æ­£è¨ˆç”»

**èª²é¡ŒID**: C1  
**å„ªå…ˆåº¦**: â­â­â­â­â­ Critical  
**ä½œæˆæ—¥**: 2025-09-10  
**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: çµ±åˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ‰¿èªæ¸ˆã¿ï¼‰

## ğŸ“‹ èª²é¡Œæ¦‚è¦

### å•é¡Œã®è©³ç´°

åŒä¸€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒ¼ãƒãƒ¼ã«3å›è»¢é€ã•ã‚Œã€ã•ã‚‰ã«ç”»åƒé¸æŠã ã‘ã—ã¦é›¢è„±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒDBã«ç„¡é§„ã«è“„ç©ã•ã‚Œã‚‹è¨­è¨ˆæ¬ é™¥ã€‚

### ç¾çŠ¶ã®è»¢é€ãƒ»ä¿å­˜ãƒ•ãƒ­ãƒ¼

```typescript
// 1å›ç›®: UploadZone.tsx:40 - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨è»¢é€ + DBä¿å­˜
const result = await uploadImage(formData); // DBä¿å­˜ç™ºç”Ÿ

// 2å›ç›®: page.tsx:54 - è¬›è©•ç”Ÿæˆæ™‚ã®è»¢é€
const result = await uploadImageWithCritique(formData);

// 3å›ç›®: actions.ts:45 - uploadImageWithCritiqueå†…ã§ã®é‡è¤‡è»¢é€ + DBå†ä¿å­˜
const uploadResult = await uploadImageCore(formData); // DBä¿å­˜ç™ºç”Ÿ

// 4å›ç›®: actions.ts:60,64 - è¬›è©•ç”Ÿæˆã§åŒä¸€ç”»åƒã‚’å†åº¦è»¢é€
critiqueFormData.append("image", formData.get("image") as File);
```

### ç„¡é§„ãªDBä½¿ç”¨ã®å•é¡Œ

- **ç”»åƒé¸æŠã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã ã‘è¦‹ã¦é›¢è„± â†’ DBã«ç„¡é§„ãªãƒ‡ãƒ¼ã‚¿è“„ç©
- **è¬›è©•å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼**: åŒä¸€ãƒ‡ãƒ¼ã‚¿ãŒ2å›DBä¿å­˜ã•ã‚Œã‚‹

## ğŸ¯ ä¿®æ­£æ–¹é‡

### çµ±åˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆ¦ç•¥

**åŸºæœ¬æ–¹é‡**: ç”»åƒé¸æŠæ™‚ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿å®Ÿè¡Œã—ã€DBä¿å­˜ã¯è¬›è©•ç”Ÿæˆæ™‚ã®1å›ã®ã¿ã¨ã™ã‚‹ã€‚

**è¨­è¨ˆåŸå‰‡**:

1. **é…å»¶å®Ÿè¡Œ**: å¿…è¦ã«ãªã‚‹ã¾ã§ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’å®Ÿè¡Œã—ãªã„
2. **ç„¡é§„æ’é™¤**: ç”»åƒé¸æŠã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®DBãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ã‚’é˜²æ­¢
3. **åŠ¹ç‡åŒ–**: è¬›è©•ç”Ÿæˆæ™‚ã«å…¨å‡¦ç†ã‚’1å›ã§å®Œçµ

## ğŸ”§ å…·ä½“çš„ãªä¿®æ­£å†…å®¹

### 1. UploadZone.tsxï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨åŒ–ï¼‰

**ç¾çŠ¶**:

```typescript
// ãƒ•ãƒ«ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ï¼ˆEXIF + ç”»åƒå‡¦ç† + DBä¿å­˜ï¼‰
const result = await uploadImage(formData);
```

**ä¿®æ­£å¾Œ**:

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿
const processImageFile = async (file: File) => {
  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ
  const preview = URL.createObjectURL(file);

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰EXIFæŠ½å‡ºï¼ˆè»½é‡ï¼‰
  const exifData = await extractExifDataClient(file);

  return { file, preview, exif: exifData };
};
```

### 2. page.tsxï¼ˆè¬›è©•ç”Ÿæˆæ™‚ã®çµ±åˆå‡¦ç†ï¼‰

**ç¾çŠ¶**:

```typescript
// åˆ†é›¢ã•ã‚ŒãŸå‡¦ç†
// 1. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®çŠ¶æ…‹
// 2. è¬›è©•ç”Ÿæˆã§å†åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
const result = await uploadImageWithCritique(formData);
```

**ä¿®æ­£å¾Œ**:

```typescript
// è¬›è©•ç”Ÿæˆæ™‚ã«åˆå›ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ + è¬›è©•ã‚’çµ±åˆå®Ÿè¡Œ
const handleGenerateCritique = async () => {
  const formData = new FormData();
  formData.append("image", uploadedImage.file);

  // åˆå›ã®DBä¿å­˜ + è¬›è©•ç”Ÿæˆã‚’åŒæ™‚å®Ÿè¡Œ
  const result = await uploadImageWithCritique(formData);
};
```

### 3. actions.tsï¼ˆé‡è¤‡å‡¦ç†å®Œå…¨æ’é™¤ï¼‰

**ç¾çŠ¶**:

```typescript
export async function uploadImageWithCritique(formData: FormData) {
  const uploadResult = await uploadImageCore(formData); // é‡è¤‡
  // ...
  const critiqueResult = await generateCritiqueCore(critiqueFormData); // é‡è¤‡è»¢é€
}
```

**ä¿®æ­£å¾Œ**:

```typescript
export async function uploadImageWithCritique(formData: FormData) {
  // 1å›ã®ã¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ + è¬›è©•ç”Ÿæˆã®çµ±åˆå‡¦ç†
  const uploadResult = await uploadImageCore(formData);

  if (!uploadResult.success) {
    return {
      upload: uploadResult,
      critique: { success: false, error: uploadResult.error },
    };
  }

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¦è¬›è©•ç”Ÿæˆï¼ˆç”»åƒå†è»¢é€ãªã—ï¼‰
  const critiqueResult = await generateCritiqueFromUploadData(
    uploadResult.data,
  );

  return { upload: uploadResult, critique: critiqueResult };
}
```

### 4. æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰EXIFå‡¦ç†

**æ–°è¦ä½œæˆ**: `src/lib/exif-client.ts`

```typescript
// ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®EXIFæŠ½å‡ºï¼ˆè»½é‡ãƒ»é«˜é€Ÿï¼‰
export async function extractExifDataClient(file: File): Promise<ExifData> {
  // exif-jsç­‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ´»ç”¨ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å‡¦ç†
}
```

## ğŸ“ å®Ÿè£…æ‰‹é †

### Phase 1: ãƒ†ã‚¹ãƒˆæº–å‚™ï¼ˆTDD - Redï¼‰

1. **æ—¢å­˜ãƒ†ã‚¹ãƒˆã®ç¢ºèª**

   ```bash
   npm run test -- --testPathPattern="upload|critique"
   ```

2. **æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ**
   - UploadZoneãŒDBä¿å­˜ã‚’è¡Œã‚ãªã„ã“ã¨ã®ãƒ†ã‚¹ãƒˆ
   - è¬›è©•ç”Ÿæˆæ™‚ã®ã¿DBä¿å­˜ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã®ãƒ†ã‚¹ãƒˆ
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰EXIFæŠ½å‡ºã®ãƒ†ã‚¹ãƒˆ

### Phase 2: æœ€å°å®Ÿè£…ï¼ˆTDD - Greenï¼‰

1. **UploadZone.tsxä¿®æ­£**
   - ã‚µãƒ¼ãƒãƒ¼å‡¦ç†å‘¼ã³å‡ºã—ã‚’å‰Šé™¤
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè£…

2. **lib/exif-client.tsæ–°è¦ä½œæˆ**
   - ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®EXIFæŠ½å‡ºæ©Ÿèƒ½

3. **actions.tsä¿®æ­£**
   - `uploadImageWithCritique`ã®é‡è¤‡æ’é™¤
   - çµ±åˆå‡¦ç†ã®å®Ÿè£…

4. **page.tsxä¿®æ­£**
   - æ–°ã—ã„ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œ

### Phase 3: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆTDD - Refactorï¼‰

1. **å‹å®šç¾©ã®æ•´ç†**
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å‡¦ç†å¯¾å¿œ

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€**
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼ã®é©åˆ‡ãªåˆ†é›¢

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–

## ğŸ¯ æœŸå¾…åŠ¹æœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

- **ç”»åƒè»¢é€é‡**: 3å› â†’ **1å›**ï¼ˆ66%å‰Šæ¸›ï¼‰
- **DBä¿å­˜**: è¬›è©•å®Ÿè¡Œæ™‚ã®ã¿ â†’ **ç„¡é§„ãªDBä½¿ç”¨é‡ã‚¼ãƒ­**
- **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º**: ã‚µãƒ¼ãƒãƒ¼å‡¦ç†å¾…æ©Ÿ â†’ **å³åº§è¡¨ç¤º**

### ã‚³ã‚¹ãƒˆå‰Šæ¸›

- **Vercelè»¢é€é‡**: 66%å‰Šæ¸›
- **Upstash KVã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: ç”»åƒé¸æŠã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†ã®ç„¡é§„æ’é™¤

### ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š

- **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**: å³åº§è¡¨ç¤ºã§ä½“æ„Ÿé€Ÿåº¦å‘ä¸Š
- **é›¢è„±ãƒ¦ãƒ¼ã‚¶ãƒ¼**: DBãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ãªã—

## ğŸ“Š å½±éŸ¿ç¯„å›²

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

- `src/components/upload/UploadZone.tsx` - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å‡¦ç†åŒ–
- `src/app/page.tsx` - çµ±åˆãƒ•ãƒ­ãƒ¼å¯¾å¿œ
- `src/app/actions.ts` - é‡è¤‡æ’é™¤ãƒ»çµ±åˆå‡¦ç†
- `src/types/upload.ts` - å‹å®šç¾©æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«

- `src/lib/exif-client.ts` - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰EXIFå‡¦ç†

### å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«

- è©²å½“ãªã—

### ä¾å­˜é–¢ä¿‚è¿½åŠ 

- `exif-js` ã¾ãŸã¯é¡ä¼¼ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰EXIFãƒ©ã‚¤ãƒ–ãƒ©ãƒª

## âœ… å®Œäº†å®šç¾©

### å¿…é ˆæ¡ä»¶

- [ ] `npm run test` å…¨é€šé
- [ ] `npm run lint` ã‚¨ãƒ©ãƒ¼ãªã—
- [ ] `npm run build` æˆåŠŸ
- [ ] ç”»åƒé¸æŠâ†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãŒå³åº§ã«å‹•ä½œ
- [ ] è¬›è©•ç”Ÿæˆæ™‚ã®ã¿DBä¿å­˜ãŒ1å›ç™ºç”Ÿã™ã‚‹ã“ã¨ã®ç¢ºèª
- [ ] ç”»åƒè»¢é€ãŒè¬›è©•ç”Ÿæˆæ™‚ã®1å›ã®ã¿ã§ã‚ã‚‹ã“ã¨ã®ç¢ºèª

### æ¤œè¨¼é …ç›®

- [ ] ç”»åƒé¸æŠã®ã¿ã§ã¯DBä¿å­˜ãŒç™ºç”Ÿã—ãªã„
- [ ] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãŒç¬æ™‚ã«å®Œäº†ã™ã‚‹
- [ ] è¬›è©•ç”ŸæˆãŒã‚¹ãƒ ãƒ¼ã‚ºã«å‹•ä½œã™ã‚‹
- [ ] EXIFæƒ…å ±ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å‹•ä½œã™ã‚‹

## ğŸš¨ ãƒªã‚¹ã‚¯ç®¡ç†

### æ½œåœ¨çš„ãƒªã‚¹ã‚¯

1. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰åˆ¶é™**: ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®EXIFæŠ½å‡ºã®åˆ¶é™
2. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç†
3. **ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§**: å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œ

### å¯¾ç­–

1. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç†å¤±æ•—æ™‚ã®ã‚µãƒ¼ãƒãƒ¼å‡¦ç†
2. **ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–**: æ®µéšçš„æ©Ÿèƒ½æä¾›
3. **ãƒ†ã‚¹ãƒˆ**: å„ç¨®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèª

## ğŸ“ˆ æ¤œè¨¼æ–¹æ³•

### æ€§èƒ½æ¸¬å®š

```typescript
// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚é–“
console.time("preview-display");
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç†
console.timeEnd("preview-display");

// DBä¿å­˜å›æ•°ã®ç¢ºèª
// ç”»åƒé¸æŠæ™‚: 0å›
// è¬›è©•ç”Ÿæˆæ™‚: 1å›ã®ã¿
```

### è‡ªå‹•ãƒ†ã‚¹ãƒˆ

```typescript
// DBä¿å­˜å›æ•°ã®ãƒ¢ãƒƒã‚¯æ¤œè¨¼
test("ç”»åƒé¸æŠæ™‚ã¯DBä¿å­˜ã•ã‚Œãªã„", () => {
  // UploadZoneæ“ä½œ
  expect(uploadImageCore).not.toHaveBeenCalled();
});

test("è¬›è©•ç”Ÿæˆæ™‚ã®ã¿DBä¿å­˜ã•ã‚Œã‚‹", () => {
  // è¬›è©•ç”Ÿæˆå®Ÿè¡Œ
  expect(uploadImageCore).toHaveBeenCalledTimes(1);
});
```

---

**å®Œäº†äºˆå®š**: 2025-09-10  
**ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼**: é–‹ç™ºãƒãƒ¼ãƒ   
**é–¢é€£èª²é¡Œ**: H1ï¼ˆUploadZoneè²¬å‹™é•åï¼‰ã€C3ï¼ˆEXIFé‡è¤‡å‡¦ç†ï¼‰
